# 🎄 至尊版圣诞树 - 技术文档

## 概述
基于 Three.js 和 MediaPipe 的交互式 3D 圣诞树网页应用，支持手势控制、照片上传、音乐播放等功能。

## 1. 目录结构

```
圣诞树项目/
├── 至尊版圣诞树🎄.html      # 主文件
├── resource/                 # 本地资源（与 HTML 同级）
│   ├── mediapipe/
│   │   ├── wasm/            # MediaPipe WASM 运行时
│   │   │   ├── vision_wasm_internal.js
│   │   │   ├── vision_wasm_internal.wasm
│   │   │   ├── vision_wasm_nosimd_internal.js
│   │   │   └── vision_wasm_nosimd_internal.wasm
│   │   └── gesture_recognizer.task  # 手势识别模型 (~5MB)
│   ├── three/               # Three.js 库（可选，默认用 CDN）
│   └── fonts/               # 字体文件（可选）
└── download_resources.sh    # 资源下载脚本
```

**重要**：HTML 文件和 resource 文件夹必须在同一层级！

## 2. 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Three.js | 0.160.0 | 3D 渲染引擎 |
| MediaPipe | 0.10.3 | AI 手势识别 |
| IndexedDB | - | 本地照片存储 |
| Web Audio | - | 背景音乐播放 |

## 3. 资源加载策略

### MediaPipe（优先本地）
```javascript
// 1. 先尝试本地文件
vision = await FilesetResolver.forVisionTasks("resource/mediapipe/wasm");
// 2. 本地失败则使用远程 CDN
vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/...");
```

### Three.js 和字体（CDN）
- Three.js: `cdn.jsdelivr.net/npm/three@0.160.0`
- 字体: `fonts.googleapis.com`

### 音乐
- 默认: `soundhelix.com` 示例音乐
- 支持用户上传自定义音乐

## 4. 初始化流程

```
[5%]   初始化场景配置
[20%]  加载 Three.js 模块
[40%]  生成圣诞装饰粒子 (6500个)
[50%]  创建星星和彩带
[55%]  准备雪花效果 (2500个)
[65%]  加载 AI 引擎 (WASM)
[85%]  下载手势模型
[95%]  启动摄像头
[100%] 完成
```

## 5. 核心功能

### 5.1 粒子系统
使用 `InstancedMesh` 高性能渲染 6500 个粒子：
- 松针: 5485
- 礼物: 260
- 彩球: 228
- 拐杖糖: 195
- 帽子: 195
- 袜子: 130
- 灯光: 7

### 5.2 视图状态
| 状态 | 触发手势 | 效果 |
|------|----------|------|
| TREE_SHAPE | ✊ 握拳 | 圣诞树形态，手掌大小控制缩放 |
| SCATTERED | 🖐 张开 | 粒子散开 |
| GALLERY | ☝️ 食指 | 相册模式，照片球形分布 |

### 5.3 手势识别
| 手势 | 效果 |
|------|------|
| ✊ 握拳 | 显示圣诞树 + 缩放控制 |
| 🖐 张开 | 粒子散开 |
| ☝️ 食指 | 相册模式 |
| 👌 捏合 | 放大最近的照片 |
| 👍 点赞 | 放烟花 |
| ✌️ 胜利 | 显示"圣诞快乐"祝福 |

### 5.4 照片功能
- 上传照片挂在圣诞树上
- 照片沿金色圆环螺旋上升
- 支持多张照片追加上传
- 照片比例自适应（横向16:9，纵向9:16）
- IndexedDB 本地存储，刷新不丢失

### 5.5 音乐功能
- 默认背景音乐
- 支持上传自定义音乐
- 音乐开关控制

## 6. UI 控件

| 控件 | 功能 |
|------|------|
| 📷 上传照片 | 选择图片挂在树上 |
| 🗑️ 清空照片 | 删除所有照片 |
| 🎶 上传音乐 | 自定义背景音乐 |
| 🎵 音乐开关 | 播放/暂停 |
| 💡 亮度 | 调节场景亮度 |
| ⛶ 全屏 | 沉浸体验，隐藏 UI |

## 7. 性能优化

1. **InstancedMesh**: 单次 DrawCall 渲染数千粒子
2. **低多边形几何体**: 减少顶点数
3. **限制像素比**: `Math.min(devicePixelRatio, 2)`
4. **关闭抗锯齿**: `antialias: false`
5. **GPU 加速**: MediaPipe 使用 `delegate: "GPU"`
6. **本地资源优先**: 减少网络延迟

## 8. 快速修改指南

### 粒子数量
```javascript
const TOTAL_PARTICLES = 6500;  // 修改总数
```

### 树的大小
```javascript
tree: { height: 26, radius: 11 }
```

### 发光强度
```javascript
new UnrealBloomPass(size, 1.5, 0.4, 0.85)
//                       强度  半径  阈值
```

### 照片大小
```javascript
const photoSize = 3.5;  // 基础大小
const maxWidth = 5;     // 最大宽度
```

## 9. 浏览器兼容性

| 功能 | Chrome | Firefox | Safari | Edge |
|------|--------|---------|--------|------|
| Three.js | ✅ | ✅ | ✅ | ✅ |
| MediaPipe | ✅ | ✅ | ⚠️ | ✅ |
| IndexedDB | ✅ | ✅ | ✅ | ✅ |
| 摄像头 | ✅ | ✅ | ✅ | ✅ |

⚠️ Safari 对 WebGL 和 MediaPipe 支持可能有限制

## 10. 部署说明

1. 将 HTML 文件和 resource 文件夹放在同一目录
2. 通过 HTTP 服务器访问（不能直接双击打开）
3. 推荐使用：`npx serve .` 或 nginx/apache

---

*文档更新: 2024年12月*
